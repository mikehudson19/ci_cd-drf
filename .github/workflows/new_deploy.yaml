  name: CI/CD Pipeline
  on:
    push:
      branches:
        - master
  env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}
    DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
    REDIS_HOST: 'localhost'
    REDIS_PORT: 6379

  jobs:
    test-build-push:
      runs-on: ubuntu-latest
      permissions:
        contents: read
        packages: write
      outputs:
        image_tag: ${{ steps.vars.outputs.sha_short }}

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set commit SHA variable
          id: vars
          run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

        - name: Set up Python
          run: |
            sudo apt-get update
            sudo apt-get install -y python3 python3-pip python3-venv

        - name: Install dependencies
          run: |
            python3 -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

        - name: Run unit tests
          run: |
            . venv/bin/activate
            python manage.py test

        - name: Set image tag
          id: meta
          run: |
            SHORT_SHA=${{ steps.vars.outputs.sha_short }}
            echo "image_tag=${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "Image tag: ${SHORT_SHA}"

        - name: Log in to GitHub Container Registry
          run: echo "${{ secrets.REPO_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

        - name: Build Docker image
          run: |
            docker build --build-arg DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }} -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }} .
            docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

        - name: Push Docker image
          run: |
            docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.sha_short }}
            docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

#    deploy:
#      runs-on: self-hosted
#      needs: test-build-push
#
#      steps:
#        - name: Log in to GitHub Container Registry
#          run: echo "${{ secrets.REPO_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
#
#        - name: Deploy with Docker Compose
#          run: |
#            cd /path/to/your/deployment/directory
#            export IMAGE_TAG=${{ needs.test-build-push.outputs.image_tag }}
#            docker compose pull api
#            docker compose up -d api
#
#        - name: Cleanup old images
#          run: |
#            # Get all image tags for this repository, sorted by creation date
#            ALL_TAGS=$(docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} --format "{{.Tag}}" | grep -v "latest" | sort -r)
#
#            # Keep current and previous image
#            CURRENT_TAG=${{ needs.test-build-push.outputs.image_tag }}
#            KEEP_TAGS=$(echo "$ALL_TAGS" | head -n 2)
#
#            # Remove all other images
#            for tag in $ALL_TAGS; do
#              if ! echo "$KEEP_TAGS" | grep -q "^${tag}$"; then
#                echo "Removing old image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${tag}"
#                docker rmi ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${tag} || true
#              fi
#            done
#
#            # Also clean up dangling images
#            docker image prune -f